<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MCP Chat Vault</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #0b0f17; color: #e8eefc; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; display: flex; gap: 20px; height: 95vh; box-sizing: border-box; }
    #auth-overlay { position: fixed; inset: 0; background: #0b0f17; display: flex; align-items: center; justify-content: center; z-index: 100; }
    .sidebar { width: 300px; background: #111827; padding: 20px; border-radius: 12px; border: 1px solid #1f2a44; display: flex; flex-direction: column; gap: 15px; }
    .main { flex: 1; display: flex; flex-direction: column; gap: 10px; }
    .card { background: #111827; border: 1px solid #1f2a44; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; height: 100%; }
    .msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
    .msg { max-width: 85%; padding: 12px 16px; border-radius: 12px; line-height: 1.5; word-wrap: break-word; }
    .user { align-self: flex-end; background: #2563eb; color: white; }
    .bot { align-self: flex-start; background: #1e293b; border: 1px solid #334155; }
    .row { display: flex; gap: 10px; padding: 15px; border-top: 1px solid #1f2a44; background: #0f172a; }
    input, select, button { padding: 10px 12px; border-radius: 8px; border: 1px solid #1f2a44; background: #0b1224; color: white; }
    button { cursor: pointer; background: #1f2a44; transition: background 0.2s; }
    button:hover { background: #334155; }
    .hidden { display: none !important; }
    h4 { margin: 0 0 5px 0; color: #94a3b8; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.05em; }
    details > summary { list-style: none; outline: none; }
    details > summary::-webkit-details-marker { display: none; }
    details[open] summary { margin-bottom: 10px; border-bottom: 1px solid #334155; padding-bottom: 5px; }
    .file-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #1f2a44; font-size: 13px; }
    .btn-del { background: #ef4444; padding: 2px 8px; font-size: 10px; border: none; }
  </style>
</head>
<body>
  <div id="auth-overlay">
    <div class="card" style="padding: 30px; width: 320px; height: auto;">
      <h2 style="margin-top:0; text-align: center;">Login</h2>
      <input id="username" placeholder="Username" style="width: 100%; box-sizing: border-box; margin-bottom: 15px;" />
      <input id="password" type="password" placeholder="Password" style="width: 100%; box-sizing: border-box; margin-bottom: 20px;" />
      <button id="login-btn" style="width: 100%; background: #2563eb; border: none;">Login</button>
    </div>
  </div>

  <div class="wrap">
    <div class="sidebar">
      <div>
        <h4>üìÇ Folders</h4>
        <select id="folder-list" style="width: 100%; margin-bottom: 10px;"></select>
        <div style="display: flex; gap: 5px;">
            <input id="new-folder-name" placeholder="New Folder..." style="flex: 1;"/>
            <button onclick="createFolder()">+</button>
        </div>
      </div>
      <hr style="width: 100%; border: 0; border-top: 1px solid #1f2a44;">
      <div>
        <h4>‚¨ÜÔ∏è Upload</h4>
        <input type="file" id="file-picker" multiple style="width: 100%; font-size: 12px; margin-bottom: 10px;"/>
        <button onclick="uploadFiles()" style="width: 100%;">Upload Files</button>
      </div>
      <hr style="width: 100%; border: 0; border-top: 1px solid #1f2a44;">
      <div style="flex: 1; overflow-y: auto;">
        <h4>üìÑ Files</h4>
        <div id="file-list" style="margin-top: 10px;"></div>
      </div>
    </div>

    <div class="main">
      <div class="card">
        <div class="header" style="padding: 15px; border-bottom: 1px solid #1f2a44; font-weight: bold; background: #0f172a;">
            LocalDocs ‚Äî Agent Chat
        </div>
        <div id="msgs" class="msgs"></div>
        <div class="row">
          <input id="input" style="flex:1" placeholder="Type a message..." />
          <button id="send">Send</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let TOKEN = "";

    async function login() {
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      const params = new URLSearchParams();
      params.append('username', u);
      params.append('password', p);

      try {
        const r = await fetch(`${API_BASE}/login`, { 
          method: "POST", 
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params 
        });
        if (r.ok) {
          const data = await r.json();
          TOKEN = data.access_token;
          document.getElementById("auth-overlay").classList.add("hidden");
          loadFolders();
        } else {
          alert("Login Failed");
        }
      } catch (e) {
        alert("Connection error: " + e.message);
      }
    }

    async function loadFolders() {
      const r = await fetch(`${API_BASE}/folders`, { headers: { "Authorization": `Bearer ${TOKEN}` } });
      if (r.ok) {
        const folders = await r.json();
        const sel = document.getElementById("folder-list");
        sel.innerHTML = folders.map(f => `<option value="${f}">${f}</option>`).join("");
        loadFiles();
      }
    }

    async function createFolder() {
      const name = document.getElementById("new-folder-name").value;
      if (!name) return;
      await fetch(`${API_BASE}/folders/${name}`, { 
        method: "POST", 
        headers: { "Authorization": `Bearer ${TOKEN}` } 
      });
      document.getElementById("new-folder-name").value = "";
      loadFolders();
    }

    async function loadFiles() {
      const folder = document.getElementById("folder-list").value;
      if (!folder) return;
      const r = await fetch(`${API_BASE}/files/${folder}`, { headers: { "Authorization": `Bearer ${TOKEN}` } });
      if (r.ok) {
        const files = await r.json();
        const container = document.getElementById("file-list");
        container.innerHTML = files.map(f => `
          <div class="file-item">
            <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px;">${f}</span>
            <button class="btn-del" onclick="deleteFile('${f}')">Delete</button>
          </div>
        `).join("");
      }
    }

    async function deleteFile(fileName) {
      const folder = document.getElementById("folder-list").value;
      if (!confirm("Delete " + fileName + "?")) return;
      const r = await fetch(`${API_BASE}/files/${folder}/${fileName}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${TOKEN}` }
      });
      if (r.ok) loadFiles();
    }

    async function uploadFiles() {
      const folder = document.getElementById("folder-list").value;
      const files = document.getElementById("file-picker").files;
      if (!folder || files.length === 0) return;
      
      const fd = new FormData();
      for (let f of files) fd.append("files", f);
      
      const r = await fetch(`${API_BASE}/upload/${folder}`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${TOKEN}` },
          body: fd
      });
      if(r.ok) {
        alert("Uploaded");
        loadFiles();
      }
    }

    function addMsg(content, who, isHtml = false) {
      const div = document.createElement("div");
      div.className = `msg ${who}`;
      if (isHtml) div.innerHTML = content;
      else div.innerText = content;
      const m = document.getElementById("msgs");
      m.appendChild(div);
      m.scrollTop = m.scrollHeight;
      return div;
    }

    function formatResponse(rawText) {
      const thoughtMatch = rawText.match(/<thinking>([\s\S]*?)<\/thinking>/);
      if (thoughtMatch) {
        const thoughtContent = thoughtMatch[1].trim();
        const finalAnswer = rawText.replace(/<thinking>[\s\S]*?<\/thinking>/, "").trim();
        return `
          <details style="margin-bottom: 10px; border: 1px solid #334155; border-radius: 8px; padding: 8px; background: #1e293b;">
            <summary style="cursor: pointer; color: #94a3b8; font-size: 0.9em; font-weight: 600;">üëÅÔ∏è Thought Process</summary>
            <div style="margin-top: 8px; font-size: 0.9em; color: #cbd5e1; white-space: pre-wrap;">${thoughtContent}</div>
          </details>
          <div>${finalAnswer}</div>
        `;
      }
      return rawText;
    }

    async function send() {
      const inputEl = document.getElementById("input");
      const text = inputEl.value.trim();
      const folder = document.getElementById("folder-list").value;
      if (!text) return;
      inputEl.value = "";
      addMsg(text, "user");
      const loadingDiv = addMsg("Thinking...", "bot");
      try {
        const payload = { 
            message: text,
            docs_dir: folder ? `user_vaults/${TOKEN}/${folder}` : null 
        };
        const r = await fetch(`${API_BASE}/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${TOKEN}` },
          body: JSON.stringify(payload)
        });
        const data = await r.json();
        loadingDiv.remove();
        if (data.answer) addMsg(formatResponse(data.answer), "bot", true);
      } catch (e) {
        loadingDiv.innerText = "Error: " + e.message;
      }
    }

    document.getElementById("login-btn").onclick = login;
    document.getElementById("send").onclick = send;
    document.getElementById("input").onkeydown = (e) => { if(e.key === "Enter") send(); };
    document.getElementById("folder-list").onchange = loadFiles;
  </script>
</body>
</html>